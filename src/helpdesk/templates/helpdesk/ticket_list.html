{% extends "helpdesk/base.html" %}

{% load i18n humanize static in_list %}

{% block helpdesk_title %}{% trans "Tickets" %}{% endblock %}

{% block helpdesk_head %}
    <!-- Timeline 3 CSS -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">
    {% else %}
    <link title="timeline-styles" rel="stylesheet" href="{% static 'helpdesk/vendor/timeline3/css/timeline.css' %}">
    {% endif %}

    <style>
        /* Force main container to handle overflow properly */
        .container-fluid {
            overflow-x: auto !important;
            max-width: 100vw !important;
        }
        
        /* Force container to not overflow */
        .card-body {
            overflow: hidden !important;
            padding: 0 !important;
        }
        
        /* Style for headers and controls */
        .card-header {
            position: relative;
            min-height: 48px;
            padding: 8px 15px;
            overflow: visible;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff !important;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* Left side - nav tabs */
        .card-header .nav-tabs {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            border-bottom: none;
        }
        
        /* Common styles for all action buttons in the top area */
        .action-buttons-container {
            display: flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
            gap: 8px !important;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .action-buttons-container > div,
        .action-buttons-container > .dropdown {
            margin-left: 8px;
        }
        
        /* Fix table header styling - ensure header is visible */
        #ticketTable {
            border-collapse: collapse !important;
            width: 100% !important;
            background-color: #fff !important;
            border: 1px solid #dee2e6 !important;
        }
        
        /* Clean header styling that matches My Tickets */
        #ticketTable thead th {
            background-color: #183b6b !important;
            color: #fff !important;
            font-weight: 500 !important;
            text-align: left !important;
            padding: 0.75rem 1rem !important;
            border: 1px solid #0e2c57 !important;
            font-size: 0.9rem !important;
            vertical-align: middle !important;
        }
        
        /* Remove DataTables scroll styling conflicts */
        .dataTables_scrollHead,
        .dataTables_scrollBody {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        /* Ensure consistent cell styling */
        #ticketTable tbody td {
            padding: 0.75rem 1rem !important;
            border: 1px solid #dee2e6 !important;
            color: #333 !important;
            vertical-align: middle !important;
        }
        
        /* Remove all the complex border removal styles that were causing issues */
        .dataTables_wrapper,
        .dataTables_scroll,
        .table-responsive {
            border: none !important;
        }
        
        /* Clean row hover effects */
        #ticketTable tbody tr:nth-child(even) {
            background-color: #f2f6fc !important;
        }
        
        #ticketTable tbody tr:hover {
            background-color: #f3eab9 !important;
            color: #183b6b !important;
        }
        
        #ticketTable tbody tr:hover a {
            color: #0066cc !important;
            text-decoration: underline !important;
        }
        
        /* Filter menu dropdown styling */
        /* Common button styling for all control buttons */
        .action-buttons-container .btn,
        .action-buttons-container .dt-button,
        .filter-menu-dropdown .dropdown-toggle,
        .select-dropdown .dropdown-toggle,
        .with-selected-dropdown .dropdown-toggle {
            background-color: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            color: #212529 !important;
            font-size: 0.875rem !important;
            padding: 0.25rem 0.5rem !important;
            height: 31px !important;
            vertical-align: middle !important;
            line-height: 1.5 !important;
        }
        
        /* Dropdown menu styling */
        .filter-dropdown-menu {
            padding: 15px 0;
            min-width: 320px;
            max-height: 80vh; /* Limit height to 80% of viewport height */
            overflow-y: auto; /* Add scrollbar when content overflows */
        }
        
        /* Container styles */
        .filter-dropdown-container,
        .select-dropdown {
            display: inline-block;
        }
        
        /* Dropdown item styling */
        .dropdown-item {
            font-size: 0.875rem;
            padding: 0.4rem 1rem;
        }
        
        .dropdown-item i {
            margin-right: 0.5rem;
        }
        
        /* With Selected Tickets dropdown styling */
        .with-selected-dropdown .dropdown-menu {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dropdown-header {
            font-size: 0.8rem;
            font-weight: bold;
            color: #6c757d;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        /* Column Visibility Dropdown Styling */
        /* Base dropdown styling */
        .dt-button-collection {
            padding: 0 !important;
            border-radius: 4px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
            max-height: 70vh !important;
            overflow-y: auto !important;
            min-width: 200px !important;
            max-width: 90vw !important;
            transform: none !important;
            position: absolute !important; /* Using absolute positioning for proper alignment */
            z-index: 1050 !important;
            background-color: white !important;
            border: 1px solid #dee2e6 !important;
        }
        
        /* Remove any background overlay/backdrop */
        .dt-button-background {
            display: none !important; /* Hide the dark backdrop */
        }
        
        .dt-button-collection .dt-button {
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 8px 16px !important;
            white-space: nowrap !important;
            font-size: 14px !important;
            color: #333 !important;
            background: #fff !important;
            transition: background-color 0.2s !important;
            margin: 0 !important;
        }
        
        .dt-button-collection .dt-button:hover {
            background-color: #f0f0f0 !important;
            color: #000 !important;
        }
        
        .dt-button-collection .dt-button.active {
            background-color: #f8f9fa !important; /* Light gray instead of blue */
            color: #212529 !important; /* Darker text color */
            font-weight: 500 !important;
        }
        
        .dt-button-collection .dt-button:focus {
            outline: none !important;
            box-shadow: none !important;
            padding-bottom: 0.5rem;
        }
        
        /* Hide the original select controls */
        .select-controls {
            display: none;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .action-buttons-container {
                position: static;
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-end;
                margin-top: 10px;
            }
            
            .action-buttons-container > div,
            .action-buttons-container > .dropdown {
                margin-top: 5px;
                margin-bottom: 5px;
            }
            
            .card-header {
                padding-bottom: 60px; /* Add space for the buttons in mobile view */
            }
            
            .filter-dropdown-menu {
                min-width: 250px;
                max-height: 70vh; /* Smaller height on mobile */
                overflow-y: auto;
                position: fixed !important; /* Force position to be fixed on mobile */
                left: 5% !important;
                right: 5% !important;
                width: 90% !important; /* Use most of screen width */
                top: 10vh !important; /* Position from the top */
                max-width: 90vw !important;
                transform: none !important;
            }
            
            /* Make buttons text stay on one line */
            .btn {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Ensure dropdowns don't get cut off */
            .dropdown-menu {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            /* Improve the column visibility dropdown */
            .dt-button-collection {
                max-height: 70vh !important;
                overflow-y: auto !important;
                width: 90vw !important;
                margin: 0 auto !important;
                left: 5% !important;
                right: 5% !important;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .select-dropdown .dropdown-toggle,
            .filter-menu-dropdown .dropdown-toggle,
            .with-selected-dropdown .dropdown-toggle,
            .custom-colvis-button {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 20px !important; /* Space for the dropdown caret */
            }
            
            .dt-button-collection {
                left: 5% !important;
                width: 90% !important;
                max-width: 90% !important;
                right: 5% !important;
                position: fixed !important;
                top: 20% !important;
                transform: none !important;
                margin: 0 !important;
            }
            
            .dt-button-collection .dt-button {
                font-size: 16px !important; /* Larger font on mobile */
                padding: 12px 16px !important; /* Larger tap target */
            }
        }
        
        /* Custom Column Visibility Dropdown Styling */
        .custom-colvis-dropdown {
            border: 1px solid #dee2e6 !important;
            border-radius: 4px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
            background-color: white !important;
            padding: 0 !important;
            margin-top: 5px !important;
            z-index: 1050 !important;
        }
        
        .custom-colvis-dropdown .dropdown-header {
            padding: 10px 16px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            background-color: #f8f9fa !important;
            border-bottom: 1px solid #dee2e6 !important;
            margin-bottom: 5px !important;
        }
        
        .custom-colvis-button {
            width: auto !important;
            min-width: 160px !important;
        }
        
        /* Improve column visibility dropdown items */
        .dt-button-collection .dt-button {
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 10px 16px !important;
            margin: 0 !important;
            font-size: 14px !important;
            color: #333 !important;
            background-color: white !important;
            transition: background-color 0.2s !important;
        }
        
        .dt-button-collection .dt-button:hover {
            background-color: #f0f0f0 !important;
            color: #000 !important;
        }
        
        .dt-button-collection .dt-button.active {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            font-weight: 500 !important;
        }
        
        /* Hide DataTables background */
        .dt-button-background {
            display: none !important;
        }

        /* Large screen responsive improvements */
        @media (min-width: 1400px) {
            /* Better table layout for very large screens */
            .action-buttons-container {
                right: 15px;
            }
            
            .filter-dropdown-menu {
                min-width: 350px;
            }
            
            .dt-button-collection {
                width: 320px !important;
            }
        }

        @media (min-width: 1200px) {
            /* Improve spacing and sizing for large screens */
            .card-body {
                padding: 1.5rem;
            }
            
            .table-responsive {
                overflow-x: scroll !important;
                overflow-y: visible !important;
                -webkit-overflow-scrolling: touch;
                width: 100% !important;
                max-width: 100% !important;
                display: block !important;
                white-space: nowrap !important;
            }
            
            /* Force scrollbar to always be visible */
            .table-responsive::-webkit-scrollbar {
                height: 12px !important;
                background-color: #f1f1f1 !important;
            }
            
            .table-responsive::-webkit-scrollbar-thumb {
                background-color: #888 !important;
                border-radius: 6px !important;
            }
            
            .table-responsive::-webkit-scrollbar-thumb:hover {
                background-color: #555 !important;
            }
            
            /* Force container to not overflow */
            .card-body {
                overflow: hidden !important;
                padding: 0 !important;
            }
            
            .tab-content {
                overflow: hidden !important;
            }
            
            .tab-pane {
                overflow: hidden !important;
                padding: 15px !important;
            }
            
            /* Ensure table fits properly */
            #ticketTable {
                min-width: 1200px !important;
                width: 100% !important;
                table-layout: auto !important;
            }
            
            /* Better button spacing and make them smaller */
            .action-buttons-container .btn,
            .action-buttons-container .dt-button,
            .filter-menu-dropdown .dropdown-toggle,
            .select-dropdown .dropdown-toggle,
            .with-selected-dropdown .dropdown-toggle {
                margin-left: 4px;
                font-size: 0.8rem !important;
                padding: 0.25rem 0.5rem !important;
                height: 28px !important;
            }
            
            /* Make the action buttons container more compact */
            .action-buttons-container {
                right: 8px;
                top: 8px;
            }
            
            .dt-button-collection {
                width: 300px !important;
            }
            
            /* Optimize table header spacing */
            #ticketTable th {
                padding: 0.5rem 0.3rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            /* Make filter dropdowns more compact */
            .filter-dropdown-menu {
                min-width: 280px;
                padding: 10px 0;
            }
        }

        @media (min-width: 992px) and (max-width: 1199px) {
            .dt-button-collection {
                width: 280px !important;
            }
            
            /* Ensure horizontal scrolling on medium-large screens */
            .table-responsive {
                overflow-x: auto;
            }
            
            #ticketTable {
                min-width: 1000px;
            }
        }
        
        @media (min-width: 768px) and (max-width: 991px) {
            .dt-button-collection {
                width: 250px !important;
            }
        }
        
        @media (min-width: 576px) and (max-width: 767px) {
            .dt-button-collection {
                width: 240px !important;
                max-height: 65vh !important;
            }
        }
        
        @media (max-width: 575px) {
            .dt-button-collection {
                width: 90% !important;
                left: 5% !important;
                right: 5% !important;
                max-height: 60vh !important;
            }
            
            .dt-button-collection .dt-button {
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
        }

        /* Pagination Component Styles */
        .pagination-nav {
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid #dee2e6;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        .page-size-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-size-label {
            font-size: 0.875rem;
            color: #495057;
            margin-bottom: 0;
            white-space: nowrap;
        }

        .page-size-select {
            width: 80px;
            height: 32px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ced4da;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .page-number {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ced4da;
            font-size: 0.875rem;
            border-radius: 4px;
            background-color: white;
            color: #495057;
        }

        .page-number.active {
            background-color: #183b6b;
            border-color: #183b6b;
            color: white;
        }

        .page-number:hover:not(.active) {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }

        .page-ellipsis {
            padding: 0 8px;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .page-info {
            display: flex;
            align-items: center;
        }

        .page-info-text {
            font-size: 0.875rem;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .page-input {
            width: 60px;
            height: 26px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.875rem;
        }

        .records-info {
            text-align: center;
        }

        /* Mobile Responsive for Pagination */
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .page-size-container,
            .pagination-controls,
            .page-info {
                justify-content: center;
            }
            
            .page-numbers {
                overflow-x: auto;
                padding: 5px 0;
            }
        }
    </style>
{% endblock %}

{% block h1_title %}Tickets
    {% if from_saved_query %} [{{ saved_query.title }}]{% endif %}
{% endblock %}


{% block helpdesk_breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
    </li>
    {% if from_saved_query and saved_query.user == user %}
        <li class="breadcrumb-item">{% trans "Saved Query" %}</li>
        <li class="breadcrumb-item active">{{ saved_query.title }}</li>
    {% else %}
        <li class="breadcrumb-item active">{% trans "Overview" %}</li>
    {% endif %}
{% endblock %}


{% block helpdesk_body %}
    <div class="card">
        {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
        <div class="card-header">
            <ul class="nav nav-tabs">
                <li class="nav-item" style="visibility: hidden; width: 0;"></li>
                <li class="nav-item">
                    <a class="nav-link active" href="#datatabletabcontents" id="datatabletabcontents-tab"
                       data-toggle="tab" role="tab" aria-controls="datatabletabcontents" aria-selected=true>
                        <i class="fas fa-th-list"></i>
                        {% trans "Table" %}
                    </a>
                </li>
                <!--<li class="nav-item">
                    <a class="nav-link" href="#timelinetabcontents" id="timelinetabcontents-tab" data-toggle="tab"
                       role="tab" aria-controls="timelinetabcontents" aria-selected=false>
                        <i class="fas fa-history"></i>
                        {% trans "Timeline" %}
                    </a>
                </li>-->
                <li class="nav-item" style="margin-left: 15px; margin-top: 4px;">
                    <div class="select-dropdown dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="selectOptionsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border: 1px solid #dee2e6;">
                            {% trans "Select" %}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="selectOptionsDropdown">
                            <a class="dropdown-item" href="#" id="select_all_btn"><i class="fas fa-check-circle"></i> {% trans "All" %}</a>
                            <a class="dropdown-item" href="#" id="select_none_btn"><i class="fas fa-times-circle"></i> {% trans "None" %}</a>
                            <a class="dropdown-item" href="#" id="select_inverse_btn"><i class="fas fa-exchange-alt"></i> {% trans "Invert" %}</a>
                        </div>
                    </div>
                </li>
            </ul>
            
            <!-- Action buttons container for all controls -->
            <div class="action-buttons-container" style="display: flex; align-items: center; justify-content: flex-end; height: 35px;">
                <!-- Filter Dropdown -->
                <div class="dropdown filter-menu-dropdown" style="margin-right: 10px;">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="filterMenuButton" 
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-filter"></i> {% trans "Filters" %}
                    </button>
                    <div class="dropdown-menu dropdown-menu-right filter-dropdown-menu" aria-labelledby="filterMenuButton">
                        <form method="get" class="px-3 py-2">
                            <!-- Sorting Filter -->
                            <div class="form-group">
                                <label for='id_sort' class="font-weight-bold">{% trans "Sorting" %}:</label>
                                <select id='id_sort' name='sort' class="form-control form-control-sm">
                                    <option value='created'{% if query_params.sorting == "created"%} selected='selected'{% endif %}>
                                        {% trans "Created" %}
                                    </option>
                                    <option value='title'{% if query_params.sorting == "title"%} selected='selected'{% endif %}>
                                        {% trans "Title" %}
                                    </option>
                                    <option value='queue'{% if query_params.sorting == "queue"%} selected='selected'{% endif %}>
                                        {% trans "Queue" %}
                                    </option>
                                    <option value='status'{% if query_params.sorting == "status"%} selected='selected'{% endif %}>
                                        {% trans "Status" %}
                                    </option>
                                    <option value='priority'{% if query_params.sorting == "priority"%} selected='selected'{% endif %}>
                                        {% trans "Priority" %}
                                    </option>
                                    <option value='assigned_to'{% if query_params.sorting == "assigned_to"%} selected='selected'{% endif %}>
                                        {% trans "Owner" %}
                                    </option>
                                </select>
                                <div class="form-check mt-1">
                                    <input type='checkbox' name='sortreverse' id='id_sortreverse' class="form-check-input"{% if query_params.sortreverse %} checked='checked'{% endif %} />
                                    <label for='id_sortreverse' class="form-check-label">{% trans "Reverse" %}</label>
                                </div>
                            </div>
                            
                            <!-- Priority Filter -->
                            <div class="form-group">
                                <label for='id_priority' class="font-weight-bold">{% trans "Priority" %}:</label>
                                <select id='id_priority' name='priority' class="form-control form-control-sm">
                                    <option value=''>{% trans "Any" %}</option>
                                    {% for p in priorities %}
                                        <option value='{{ p.pk }}'{% if query_params.filtering.priority__in and p.pk|in_list:query_params.filtering.priority__in %} selected='selected'{% endif %}>{{ p }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="form-group">
                                <label for='id_status' class="font-weight-bold">{% trans "Status" %}:</label>
                                <select id='id_status' name='status' class="form-control form-control-sm">
                                    <option value=''>{% trans "Any" %}</option>
                                    {% for s in status_choices %}
                                        <option value='{{ s.0 }}'{% if query_params.filtering.status__in and s.0|in_list:query_params.filtering.status__in %} selected='selected'{% endif %}>{{ s.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Apply Button -->
                            <div class="form-group mt-3 mb-0">
                                <input class="btn btn-primary btn-sm btn-block" type='submit' value='{% trans "Apply Filters" %}'/>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Column Visibility button will be placed here by DataTables -->
                <div id="column-visibility-container" style="margin-right: 10px;"></div>
                
                <!-- With Selected Tickets Dropdown -->
                <div class="dropdown with-selected-dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="withSelectedDropdown" 
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border: 1px solid #dee2e6;">
                        <i class="fas fa-tasks"></i> {% trans "Actions" %}
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="withSelectedDropdown">
                        <h6 class="dropdown-header">{% trans "With Selected Tickets" %}</h6>
                        <a class="dropdown-item mass-action-item" href="#" data-action="take"><i class="fas fa-hand-paper"></i> {% trans "Take (Assign to me)" %}</a>
                        <a class="dropdown-item mass-action-item" href="#" data-action="delete"><i class="fas fa-trash"></i> {% trans "Delete" %}</a>
                        <a class="dropdown-item mass-action-item" href="#" data-action="merge"><i class="fas fa-object-group"></i> {% trans "Merge" %}</a>
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">{% trans "Close" %}</h6>
                        <a class="dropdown-item mass-action-item" href="#" data-action="close"><i class="fas fa-times-circle"></i> {% trans "Close (Don't Send E-Mail)" %}</a>
                        <a class="dropdown-item mass-action-item" href="#" data-action="close_public"><i class="fas fa-envelope"></i> {% trans "Close (Send E-Mail)" %}</a>
                        {% if kb_items %}
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">{% trans "Set KB Item" %}</h6>
                        <a class="dropdown-item mass-action-item" href="#" data-action="kbitem_none"><i class="fas fa-minus-circle"></i> {% trans "No KB Item" %}</a>
                        {% for kbi in kb_items %}
                            <a class="dropdown-item mass-action-item" href="#" data-action="kbitem_{{ kbi.id }}"><i class="fas fa-book"></i> {{ kbi.category.title }}: {{ kbi.title }}</a>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="card-body">
            {{ search_message|safe }}
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="datatabletabcontents" role="tabpanel"
                     aria-labelledby="datatabletabcontents-tab">
                    
                    <form method='post' action='{% url 'helpdesk:mass_update' %}' id="ticket_mass_update">
                        {% csrf_token %}
                        <div style="overflow-x: scroll; overflow-y: visible; width: 100%; border: 1px solid #ddd;">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover"
                                       id="ticketTable" data-page-length='{{ default_tickets_per_page }}'>
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>{% trans "Ticket" %}</th>
                                            <th>{% trans "Priority" %}</th>
                                            <th>{% trans "Queue" %}</th>
                                            <th>{% trans "Status" %}</th>
                                            <th>{% trans "Created" %}</th>
                                            <th>{% trans "Due Date" %}</th>
                                            <th>{% trans "Owner" %}</th>
                                            <th>{% trans "Submitter" %}</th>
                                            <th>{% trans "Last Followup" %}</th>
                                            {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}<th>{% trans "Time Spent" %}</th>{% endif %}
                                            {% if helpdesk_settings.HELPDESK_KB_ENABLED %}<th>{% trans "KB item" %}</th>{% endif %}
                                        </tr>
                                    </thead>
                                </table>
                        </div>
                        </div>

                        <!-- Include the reusable pagination component -->
                        {% include 'helpdesk/components/pagination.html' %}

                        <!-- Hidden form elements for mass actions -->
                        <div class="select-controls" style="display: none;">
                            <input type="hidden" name="action" id="id_mass_action" value="" />
                        </div>
                    </form>
                </div>
                {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
                <div class="tab-pane fade" id="timelinetabcontents" role="tabpanel" aria-labelledby="timelinetabcontents-tab">
                    <div id='timeline-embed' style="width: 100%; height: 80vh"></div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->



{% endblock %}


{% block helpdesk_js %}
    <script src='{% static "helpdesk/filter.js" %}'></script>
    <script src='{% static "helpdesk/js/enhanced-tickets.js" %}'></script>
    <!-- Timeline 3 JavaScript -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
    {% else %}
    <script src="{% static 'helpdesk/vendor/timeline3/js/timeline.js' %}"></script>
    {% endif %}

    <script>
        window.helpdesk_settings = {
            LANGUAGE_CODE: "{{ helpdesk_settings.LANGUAGE_CODE|default:'en-US' }}",
            NO_FOLLOWUP_TEXT: "{% trans helpdesk_settings.ALTERNATIVE_UI_STRINGS.No_followup_found|default:'No followup found' %}"
        };

        function get_url(row) {
            return "{% url 'helpdesk:view' 1234 %}".replace(/1234/, row.id.toString());
        }
        
        function htmlEntities(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        $(document).ready(function () {
                // Custom handling of column visibility dropdown
            $(document).on('click', 'button.buttons-colvis', function(e) {
                e.preventDefault();
                
                // Store reference to button for later positioning
                window.lastClickedColvisBtn = this;
                
                // Add a tiny delay to ensure the dropdown is created before we try to modify it
                setTimeout(function() {
                    if (window.lastClickedColvisBtn) {
                        var $btn = $(window.lastClickedColvisBtn);
                        var btnPos = $btn.offset();
                        var btnHeight = $btn.outerHeight();
                        
                        // Position the dropdown properly below the button
                        $('.dt-button-collection').css({
                            'position': 'absolute',
                            'top': (btnPos.top + btnHeight) + 'px',
                            'left': btnPos.left + 'px',
                            'width': '250px',
                            'z-index': 1050
                        });
                        
                        // Add styling to make it look better
                        $('.dt-button-collection').addClass('custom-colvis-dropdown');
                        
                        // Add headers if needed
                        if (!$('.dt-button-collection').find('.dropdown-header').length) {
                            $('.dt-button-collection').prepend('<h6 class="dropdown-header" style="padding: 10px 16px; font-weight: bold; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">{% trans "Toggle Column Visibility" %}</h6>');
                        }
                        
                        // Style all buttons in the dropdown
                        $('.dt-button-collection .dt-button').css({
                            'display': 'block',
                            'width': '100%',
                            'text-align': 'left',
                            'border': 'none',
                            'border-radius': '0',
                            'padding': '10px 16px',
                            'background': 'white',
                            'color': '#333',
                            'font-size': '14px',
                            'margin': '0'
                        });
                        
                        // Add active state styling - use light gray instead of blue
                        $('.dt-button-collection .dt-button.active').css({
                            'background-color': '#f8f9fa',
                            'color': '#212529',
                            'font-weight': '500'
                        });
                        
                        // Add hover effects for better accessibility - consistent gray colors
                        $('.dt-button-collection .dt-button').hover(
                            function() { 
                                $(this).css('background-color', '#f0f0f0'); 
                            },
                            function() { 
                                if ($(this).hasClass('active')) {
                                    $(this).css('background-color', '#f8f9fa'); 
                                } else {
                                    $(this).css('background-color', 'white'); 
                                }
                            }
                        );
                        
                        // Close dropdown when clicking outside
                        $(document).one('click', function closeColvis(e) {
                            if (!$(e.target).closest('.dt-button-collection').length && !$(e.target).closest('button.buttons-colvis').length) {
                                $('.dt-button-collection').hide();
                            } else if (!$(e.target).closest('button.buttons-colvis').length) {
                                $(document).one('click', closeColvis);
                            }
                        });
                    }
                }, 10);
            });
            
            // Ticket DataTable Initialization
	    $.fn.dataTable.ext.errMode = function(settings, helpPage, message) {
		console.error("DataTables Error:", message);
		alert("{% trans 'Error fetching tickets occured, please contact the system administrators of this server providing the message below:\n    ' %}" + message)
	    };
	    
	    // Add debugging
	    console.log("Initializing DataTable...");
	    
            var table = $('#ticketTable').DataTable({
                language: {
                    "emptyTable": "{% trans 'No Tickets Match Your Selection' %}"
                },
                processing: true,
                serverSide: true,
                ajax: {
                    "url": "{% url 'helpdesk:datatables_ticket_list' urlsafe_query %}",
                    "type": "GET",
                    "error": function(xhr, error, code) {
                        console.error("AJAX Error:", error, code, xhr.responseText);
                    }
                },
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass(data.row_class);
                },
                dom: 'tB',
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50, 100],
                buttons: [
                    {
                        extend: 'colvis',
                        className: 'custom-colvis-button',
                        collectionLayout: 'fixed',
                        fade: 0, // Disable fade effect
                        background: false, // Disable background/backdrop
                        text: '<i class="fas fa-columns"></i> {% trans "Column visibility" %}',
                        titleAttr: '{% trans "Toggle column visibility" %}',
                        postfixButtons: [
                            {
                                extend: 'colvisGroup',
                                text: '{% trans "Show all" %}',
                                show: ':hidden'
                            },
                            {
                                extend: 'colvisGroup',
                                text: '{% trans "Hide all" %}',
                                hide: ':visible'
                            }
                        ]
                    }
                ],
                columns: [
                    {
                        data: "id",
                        title: "",
                        orderable: false,
                        render: function (data, type, row, meta) {
                            const pk = data;
                            if (type === 'display') {
                                data = "<input type='checkbox' name='ticket_id' value='" + pk + "' class='ticket_multi_select' />"
                            }
                            return data
                        }
                    },
                    {
                        data: "ticket",
                        title: "{% trans 'Ticket' %}",
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<div class="tickettitle"><a href="' + get_url(row) + '" class="ticket-title">' +
                                    row.id + '. ' +
                                    htmlEntities(row.title) + '</a></div>';
                            }
                            return data
                        }
                    },
                    {
                        data: "priority",
                        title: "{% trans 'Priority' %}",
                        render: function (data, type, row, meta) {
                            let priorityClass = "priority-5";
                            switch (data) {
                                case 1:
                                    priorityClass = "priority-1";
                                    break;
                                case 2:
                                    priorityClass = "priority-2";
                                    break;
                                case 3:
                                    priorityClass = "priority-3";
                                    break;
                                case 4:
                                    priorityClass = "priority-4";
                                    break;
                                case 5:
                                    priorityClass = "priority-5";
                                    break;
                            }
                            return '<span class="' + priorityClass + '">' + data + '</span>';
                        },
                        visible: true,
                    },
                    {
                        data: "queue",
                        title: "{% trans 'Queue' %}",
                        render: function (data, type, row, meta) {
                            return data.title;
                        },
                        visible: false,
                    },
                    {
                        data: "status",
                        title: "{% trans 'Status' %}",
                        render: function (data, type, row) {
                            let statusClasses = {
                                'Open': 'status-open',
                                'Reopened': 'status-reopened',
                                'Resolved': 'status-resolved',
                                'Closed': 'status-closed',
                                'In Progress': 'status-open',
                                'On Hold': 'status-hold'
                            };
                            let statusClass = statusClasses[data] || 'status-open';
                            return '<span class="ticket-status ' + statusClass + '">' + data + '</span>';
                        }
                    },
                    {
                        data: "created",
                        title: "{% trans 'Created' %}"
                    },
                    {
                        data: "due_date",
                        title: "{% trans 'Due Date' %}",
                        visible: false
                    },
                    {
                        data: "assigned_to",
                        title: "{% trans 'Owner' %}",
                        render: function (data, type, row, meta) {
                            if (data !== "None") {
                                return data;
                            }
                            return "";
                        }
                    },
                    {
                        data: "submitter",
                        title: "{% trans 'Submitter' %}"
                    },
                    {
                        data: "last_followup",
                        title: "{% trans 'Last Followup' %}",
                        render: function (data, type, row) {
                            let locale = navigator.language || navigator.userLanguage || window.helpdesk_settings.LANGUAGE_CODE;
                            
                            if (isNaN(Date.parse(data))) {
                                return window.helpdesk_settings.NO_FOLLOWUP_TEXT;
                            }

                            let date = new Date(data);
                            return date.toLocaleString(locale, {
                                weekday: "short",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true
                            });
                        }
                    }{% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %},
                    {
                        data: "time_spent",
                        title: "{% trans 'Time Spent' %}",
                        visible: false
                    }{% endif %}{% if helpdesk_settings.HELPDESK_KB_ENABLED %},
                    {
                        data: "kbitem",
                        title: "{% trans 'KB item' %}"
                    }{% endif %}
                ],
                order: [],
                initComplete: function(settings, json) {
                    console.log("DataTable initialized successfully");
                    console.log("Data received:", json);
                },
                drawCallback: function(settings) {
                    console.log("DataTable draw completed");
                    console.log("Rows:", this.api().rows().count());
                }
            });
            
            console.log("DataTable created successfully");
            
            // Get DataTable instance for pagination integration
            var ticketTable = table;
            
            // Initialize custom pagination and integrate with DataTables
            var ticketPagination;
            
            // Initialize pagination after DataTable is ready
            ticketTable.on('init.dt', function () {
                // Force the page length to be 10 on initial load
                ticketTable.page.len(10);
                
                setTimeout(function() {
                    ticketPagination = initPagination('.pagination-nav', {
                        pageSize: 10,
                        totalRecords: ticketTable.page.info().recordsTotal,
                        currentPage: ticketTable.page.info().page + 1,
                        onPageChange: function(page, pageSize) {
                            ticketTable.page(page - 1).draw('page');
                        },
                        onPageSizeChange: function(pageSize, page) {
                            ticketTable.page.len(pageSize).draw();
                        }
                    });
                    
                    // Force redraw to apply the page length
                    ticketTable.draw();
                }, 100);
            });
            
            // Update pagination info when DataTable draws
            ticketTable.on('draw.dt', function () {
                if (ticketPagination) {
                    var info = ticketTable.page.info();
                    ticketPagination.updateTotalRecords(info.recordsTotal);
                    ticketPagination.setCurrentPage(info.page + 1);
                }
            });
            
            // Hide default DataTables pagination elements
            $('.dataTables_length, .dataTables_paginate').hide();
            
            // Fix positioning and styling of DataTables buttons
            setTimeout(function() {
                // Make sure there's only one Column Visibility button
                if ($('div.dt-buttons').length > 1) {
                    $('div.dt-buttons:not(:first)').remove();
                }
                
                // Event handler for dropdown positioning is now defined further down
                
                // Move the column visibility button to our container
                $('div.dt-buttons').detach().appendTo('#column-visibility-container');
                
                // Enhance the column visibility button with better text and icon
                $('div.dt-buttons button.buttons-colvis')
                    .html('<i class="fas fa-columns"></i> {% trans "Column visibility" %}')
                    .attr('title', '{% trans "Toggle column visibility" %}')
                    .addClass('custom-colvis-button');
                    
                // Positioning is now handled in the button click handler
                
                // Create completely new styled button (better approach than replacing)
                var $colvisBtn = $('div.dt-buttons button.buttons-colvis');
                $colvisBtn.addClass('btn btn-light btn-sm');
                
                // Apply common styling
                $colvisBtn.css({
                    'background-color': '#f8f9fa',
                    'border': '1px solid #dee2e6',
                    'color': '#212529',
                    'font-size': '0.875rem',
                    'padding': '0.25rem 0.5rem',
                    'height': '31px',
                    'vertical-align': 'middle',
                    'line-height': '1.5',
                    'margin': '0',
                    'white-space': 'nowrap',
                    'text-overflow': 'ellipsis',
                    'min-width': '160px'
                });
                
                // Modify the button's click behavior to improve dropdown positioning
                $colvisBtn.on('mousedown', function(e) {
                    e.stopPropagation();
                });
                
                // Add custom handler for the column visibility dropdown
                $(document).on('click', '.dt-button-collection .dt-button', function() {
                    // Apply active state for better visual feedback
                    $(this).toggleClass('active');
                });
                
                // Set equal height and vertical alignment for all dropdown buttons
                $('.action-buttons-container .dropdown-toggle, .action-buttons-container .dt-button').css({
                    'height': '31px',
                    'vertical-align': 'middle',
                    'line-height': '1.5',
                    'border': '1px solid #dee2e6'
                });
                
                // Hide any duplicate column visibility buttons that might be at the bottom
                $('.column-visibility-bottom').hide();
                
                // Remove any DataTables backgrounds that might cause dark overlay
                $('.dt-button-background').remove();
                
                // Handle future backgrounds that might be created
                $(document).on('buttons-action', function() {
                    $('.dt-button-background').remove();
                });
                
                // Handle future backgrounds that might be created
                $(document).on('buttons-action', function() {
                    $('.dt-button-background').remove();
                });
            }, 300);

            {# Timeline initialization when tab is displayed #}
            // The TL.Timeline constructor takes at least two arguments:
            // the id of the Timeline container (no '#'), and
            // the URL to your JSON data file or Google spreadsheet.
            // the id must refer to an element "above" this code,
            // and the element must have CSS styling to give it width and height
            // optionally, a third argument with configuration options can be passed.
            // See below for more about options.
            let timeline_loaded = false;
            $('#timelinetabcontents-tab').on('shown.bs.tab', function (e) {
                if (!timeline_loaded) {
                    new TL.Timeline(
                        'timeline-embed',
                        '{% url 'helpdesk:timeline_ticket_list' urlsafe_query %}'
                    );
                    timeline_loaded = true;
                }
            });

            {# Shortcuts to select/unselect multiple tickets #}
            $("#select_all_btn").click(function () {
                $(".ticket_multi_select").prop('checked', true);
            });
            $("#select_none_btn").click(function () {
                $(".ticket_multi_select").prop('checked', false);
            });
            $("#select_inverse_btn").click(function () {
                $(".ticket_multi_select").each(function () {
                    $(this).prop('checked', !$(this).prop('checked'));
                });
            });
            
            {# Handle mass actions from dropdown #}
            $(".mass-action-item").click(function(e) {
                e.preventDefault();
                
                // Check if any tickets are selected
                if ($(".ticket_multi_select:checked").length === 0) {
                    alert("{% trans 'Please select at least one ticket first.' %}");
                    return false;
                }
                
                // Set the action value
                $("#id_mass_action").val($(this).data('action'));
                
                // Submit the form
                $("#ticket_mass_update").submit();
            });
        })
        
        // Pagination Class
        class ReusablePagination {
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId) || document.querySelector(containerId);
                this.options = {
                    pageSize: options.pageSize || 10,
                    currentPage: options.currentPage || 1,
                    totalRecords: options.totalRecords || 0,
                    maxVisiblePages: options.maxVisiblePages || 5,
                    onPageChange: options.onPageChange || function() {},
                    onPageSizeChange: options.onPageSizeChange || function() {},
                    ...options
                };
                
                this.totalPages = Math.ceil(this.options.totalRecords / this.options.pageSize);
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.render();
            }
            
            bindEvents() {
                const pageSizeSelect = this.container.querySelector('#pageSize');
                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', (e) => {
                        this.changePageSize(parseInt(e.target.value));
                    });
                }
                
                const prevBtn = this.container.querySelector('#prevBtn');
                const nextBtn = this.container.querySelector('#nextBtn');
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => this.previousPage());
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => this.nextPage());
                }
                
                const pageInput = this.container.querySelector('#pageInput');
                if (pageInput) {
                    pageInput.addEventListener('change', (e) => {
                        const page = parseInt(e.target.value);
                        if (page >= 1 && page <= this.totalPages) {
                            this.goToPage(page);
                        } else {
                            e.target.value = this.options.currentPage;
                        }
                    });
                }
                
                const pageNumbers = this.container.querySelector('#pageNumbers');
                if (pageNumbers) {
                    pageNumbers.addEventListener('click', (e) => {
                        if (e.target.classList.contains('page-number')) {
                            const page = parseInt(e.target.dataset.page);
                            this.goToPage(page);
                        }
                    });
                }
            }
            
            render() {
                this.updatePageNumbers();
                this.updatePageInfo();
                this.updateRecordsInfo();
                this.updateButtons();
            }
            
            updatePageNumbers() {
                const pageNumbers = this.container.querySelector('#pageNumbers');
                if (!pageNumbers) return;
                
                pageNumbers.innerHTML = '';
                
                const start = Math.max(1, this.options.currentPage - Math.floor(this.options.maxVisiblePages / 2));
                const end = Math.min(this.totalPages, start + this.options.maxVisiblePages - 1);
                
                if (start > 1) {
                    pageNumbers.appendChild(this.createPageButton(1));
                    if (start > 2) {
                        pageNumbers.appendChild(this.createEllipsis());
                    }
                }
                
                for (let i = start; i <= end; i++) {
                    pageNumbers.appendChild(this.createPageButton(i));
                }
                
                if (end < this.totalPages) {
                    if (end < this.totalPages - 1) {
                        pageNumbers.appendChild(this.createEllipsis());
                    }
                    pageNumbers.appendChild(this.createPageButton(this.totalPages));
                }
            }
            
            createPageButton(page) {
                const button = document.createElement('button');
                button.className = `btn btn-sm ${page === this.options.currentPage ? 'btn-primary active' : 'btn-outline-secondary'} page-number`;
                button.dataset.page = page;
                button.textContent = page;
                return button;
            }
            
            createEllipsis() {
                const span = document.createElement('span');
                span.className = 'page-ellipsis';
                span.textContent = '...';
                return span;
            }
            
            updatePageInfo() {
                const pageInput = this.container.querySelector('#pageInput');
                const totalPagesSpan = this.container.querySelector('#totalPages');
                
                if (pageInput) {
                    pageInput.value = this.options.currentPage;
                    pageInput.max = this.totalPages;
                }
                
                if (totalPagesSpan) {
                    totalPagesSpan.textContent = this.totalPages;
                }
            }
            
            updateRecordsInfo() {
                const recordsStart = this.container.querySelector('#recordsStart');
                const recordsEnd = this.container.querySelector('#recordsEnd');
                const totalRecords = this.container.querySelector('#totalRecords');
                
                const start = (this.options.currentPage - 1) * this.options.pageSize + 1;
                const end = Math.min(this.options.currentPage * this.options.pageSize, this.options.totalRecords);
                
                if (recordsStart) recordsStart.textContent = this.options.totalRecords > 0 ? start : 0;
                if (recordsEnd) recordsEnd.textContent = end;
                if (totalRecords) totalRecords.textContent = this.options.totalRecords;
            }
            
            updateButtons() {
                const prevBtn = this.container.querySelector('#prevBtn');
                const nextBtn = this.container.querySelector('#nextBtn');
                
                if (prevBtn) {
                    prevBtn.disabled = this.options.currentPage === 1;
                }
                
                if (nextBtn) {
                    nextBtn.disabled = this.options.currentPage === this.totalPages || this.totalPages === 0;
                }
            }
            
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages && page !== this.options.currentPage) {
                    this.options.currentPage = page;
                    this.render();
                    this.options.onPageChange(page, this.options.pageSize);
                }
            }
            
            previousPage() {
                this.goToPage(this.options.currentPage - 1);
            }
            
            nextPage() {
                this.goToPage(this.options.currentPage + 1);
            }
            
            changePageSize(newSize) {
                this.options.pageSize = newSize;
                this.totalPages = Math.ceil(this.options.totalRecords / this.options.pageSize);
                this.options.currentPage = 1;
                this.render();
                this.options.onPageSizeChange(newSize, this.options.currentPage);
            }
            
            updateTotalRecords(totalRecords) {
                this.options.totalRecords = totalRecords;
                this.totalPages = Math.ceil(totalRecords / this.options.pageSize);
                
                if (this.options.currentPage > this.totalPages && this.totalPages > 0) {
                    this.options.currentPage = this.totalPages;
                }
                
                this.render();
            }
            
            setCurrentPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.options.currentPage = page;
                    this.render();
                }
            }
        }
        
        // Global function for easy initialization
        window.initPagination = function(containerId, options = {}) {
            return new ReusablePagination(containerId, options);
        };
    </script>
{% endblock %}

