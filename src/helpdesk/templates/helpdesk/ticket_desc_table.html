{% load i18n humanize ticket_to_link %}
{% load static %}
{% load helpdesk_util %}

<style>
/* Enhanced table styling for better visibility */
.table-border {
    border: 2px solid #e1e5e9 !important;
    background-color: #ffffff !important;
}

/* Ticket details responsive table improvements */
.table-responsive {
    overflow-x: auto !important;
    overflow-y: visible !important;
    -webkit-overflow-scrolling: touch !important;
    max-width: 100% !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 6px !important;
}

/* Enhanced scrollbar for ticket details */
.table-responsive::-webkit-scrollbar {
    height: 12px !important;
    background-color: #f8f9fa !important;
}

.table-responsive::-webkit-scrollbar-thumb {
    background-color: #6c757d !important;
    border-radius: 6px !important;
    border: 2px solid #f8f9fa !important;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background-color: #495057 !important;
}

/* Ensure table doesn't break on small screens */
.table-responsive table {
    min-width: 600px !important;
    margin-bottom: 0 !important;
}

/* Mobile responsive improvements */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem !important;
        border-radius: 4px !important;
    }
    
    .table-responsive table {
        min-width: 500px !important;
    }
    
    .table-responsive th,
    .table-responsive td {
        padding: 0.75rem 0.5rem !important;
        white-space: nowrap !important;
    }
    
    /* Enhanced mobile scrollbar */
    .table-responsive::-webkit-scrollbar {
        height: 15px !important;
        background-color: #e9ecef !important;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background-color: #6c757d !important;
        border-radius: 8px !important;
        border: 2px solid #e9ecef !important;
    }
}

.table-border th,
.table-border td {
    border: 1px solid #e1e5e9 !important;
    padding: 16px 20px !important;
    vertical-align: middle !important;
    background-color: #ffffff !important;
}

.table-border thead th {
    background-color: #ffffff !important;
    border-bottom: 2px solid #e1e5e9 !important;
    font-weight: 600 !important;
}

.table-border .table-active {
    background-color: #ffffff !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    width: 200px !important;
    white-space: nowrap !important;
    border-right: 2px solid #e1e5e9 !important;
    font-size: 14px !important;
    letter-spacing: 0.3px !important;
}

/* Header row styling */
.table-border thead tr th {
    position: relative;
    padding: 20px 15px !important;
}

.table-border thead tr th h3 {
    margin: 0 !important;
    padding: 0 !important;
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    color: #183b6b !important;
    display: inline-block !important;
}

/* Ticket toolbar alignment */
.ticket_toolbar {
    position: absolute !important;
    top: 50% !important;
    right: 15px !important;
    transform: translateY(-50%) !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

.ticket_toolbar .btn-group {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

.ticket_toolbar .btn {
    white-space: nowrap !important;
    font-size: 0.875rem !important;
    padding: 8px 16px !important;
    border-radius: 6px !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
}

.ticket_toolbar .btn-warning {
    background-color: #183b6b !important;
    border-color: #183b6b !important;
    color: white !important;
}

.ticket_toolbar .btn-warning:hover {
    background-color: #0f2847 !important;
    border-color: #0f2847 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.ticket_toolbar .btn-danger {
    background-color: #e74c3c !important;
    border-color: #e74c3c !important;
    color: white !important;
}

.ticket_toolbar .btn-danger:hover {
    background-color: #c0392b !important;
    border-color: #c0392b !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.ticket_toolbar .btn-secondary {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: white !important;
}

.ticket_toolbar .btn-secondary:hover {
    background-color: #545b62 !important;
    border-color: #545b62 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.ticket_toolbar .form-inline {
    display: inline-block !important;
    margin: 0 !important;
}

/* Remove the | separators and improve spacing */
.ticket_toolbar .btn-group {
    flex-wrap: nowrap !important;
}

/* Enhanced row hover effects */
.table-border tbody tr:hover {
    background-color: #f8fafe !important;
    transition: background-color 0.2s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
}

.table-border tbody tr:hover .table-active {
    background-color: #f8fafe !important;
}

/* Better form styling within table */
.table-border .form-control {
    border: 1px solid #ced4da !important;
    border-radius: 4px !important;
    padding: 6px 12px !important;
    font-size: 0.875rem !important;
}

.table-border .btn-primary {
    background-color: #183b6b !important;
    border-color: #183b6b !important;
    color: white !important;
}

.ticket_toolbar .btn-primary {
    background-color: #183b6b !important;
    border-color: #183b6b !important;
    color: white !important;
}

.ticket_toolbar .btn-primary:hover {
    background-color: #0f2847 !important;
    border-color: #0f2847 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.table-border .btn-primary:hover {
    background-color: #0e2c57 !important;
    border-color: #0e2c57 !important;
}

/* Professional table content styling */
.table-border tbody td {
    font-size: 14px !important;
    color: #2c3e50 !important;
    line-height: 1.5 !important;
}

.table-border tbody td strong {
    font-weight: 600 !important;
    color: #1a252f !important;
}

/* Clean badge/button styling within table */
.table-border .badge {
    font-size: 12px !important;
    padding: 6px 12px !important;
    font-weight: 500 !important;
    border-radius: 6px !important;
}

/* Professional spacing for table rows */
.table-border tbody tr {
    border-bottom: 1px solid #e1e5e9 !important;
}

.table-border tbody tr:last-child {
    border-bottom: 2px solid #e1e5e9 !important;
}

/* Card styling improvements */
.card {
    border: none !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    border-radius: 8px !important;
    overflow: hidden !important;
}

/* Table responsive improvements */
.table-responsive {
    border-radius: 8px !important;
    overflow: hidden !important;
}

/* Priority cell styling */
.table-warning {
    background-color: #fff3cd !important;
    border-color: #ffeaa7 !important;
}

/* Status indicators */
.btn-info {
    background-color: #17a2b8 !important;
    border-color: #17a2b8 !important;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .ticket_toolbar {
        position: static !important;
        transform: none !important;
        margin-top: 15px !important;
        justify-content: flex-start !important;
    }
    
    .ticket_toolbar .btn {
        font-size: 0.8rem !important;
        padding: 6px 12px !important;
    }
    
    .table-border thead tr th h3 {
        font-size: 1.5rem !important;
        margin-bottom: 10px !important;
    }
    
    .table-border .table-active {
        width: auto !important;
        white-space: normal !important;
    }
}
</style>

<div class="card mb-3">
    <!--div class="card-header">
        {# trans "Ticket Summary" #}
    </div -->
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-border">
                <thead class="thead-light">
                    <tr class=''>
                        <th colspan='4'>
                            <h3>{{ ticket.title }}</h3>
                            <span class='ticket_toolbar float-right'>
                                <div class="btn-group">
                                    <a href="{% url 'helpdesk:edit' ticket.id %}" class="btn btn-primary btn-sm ticket-edit">
                                        <i class="fas fa-pencil-alt"></i> {% trans "Edit" %}
                                    </a>
                                    <!--<a href="{% url 'helpdesk:delete' ticket.id %}" class="btn btn-danger btn-sm ticket-delete">
                                        <i class="fas fa-trash-alt"></i> {% trans "Delete" %}
                                    </a>-->
                                    {% if ticket.on_hold %}
                                        <form class="form-inline ticket-hold" method='post' action='unhold/'>
                                            {% csrf_token %}
                                            <button class="btn btn-secondary btn-sm" type='submit'>
                                                <i class="fas fa-play"></i> {% trans "Unhold" %}
                                            </button>
                                        </form>
                                    {% else %}
                                        <form class="form-inline ticket-hold" method='post' action='hold/'>
                                            {% csrf_token %}
                                            <button class="btn btn-secondary btn-sm" type='submit'>
                                                <i class="fas fa-pause"></i> {% trans "Hold" %}
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for customfield in ticket.ticketcustomfieldvalue_set.all %}
                        <tr>
                            <th class="table-secondary">{{ customfield.field.label }}</th>
                            <td>
                                {% spaceless %}
                                    {% if "url" == customfield.field.data_type %}
                                        <a href='{{ customfield.value }}'>{{ customfield.value }}</a>
                                    {% elif "datetime" == customfield.field.data_type %}
                                        {{ customfield.value|datetime_string_format }}
                                    {% elif "date" == customfield.field.data_type %}
                                        {{ customfield.value|datetime_string_format }}
                                    {% elif "time" == customfield.field.data_type %}
                                        {{ customfield.value|datetime_string_format }}
                                    {% else %}
                                        {{ customfield.value|default:"" }}
                                    {% endif %}
                                {% endspaceless %}
                            </td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <th class="table-active">{% trans "Due Date" %}</th>
                        <td>
                            {{ ticket.due_date|date:"DATETIME_FORMAT" }}
                            {% if ticket.due_date %}({{ ticket.due_date|naturaltime }}){% endif %}
                        </td>
                        <th class="table-active">{% trans "Submitted On" %}</th>
                        <td>{{ ticket.created|date:"DATETIME_FORMAT" }} ({{ ticket.created|naturaltime }})</td>
                    </tr>
                    <tr>
                        <!-- show current Assignee for ticket -->
                        <th class="table-active">{% trans "Assigned To" %}</th>
                        <td>
                            <!-- assignment drop down -->
                            <form method="post" action="{% url 'helpdesk:update' ticket.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                                <!-- Keep current queue and priority hidden so they're unchanged -->
                                <input type="hidden" name="queue" value="{{ ticket.queue.id }}">
                                <input type="hidden" name="priority" value="{{ ticket.priority }}">

                                <!-- Summary / Title hidden to avoid validation error -->
                                <input type="hidden" name="title" value="{{ ticket.title }}">

                                <div class="d-flex align-items-center gap-2">
                                    <div class="input-group input-group-sm" style="width: auto;">
                                        <select name="owner" class="form-control">
                                            <option value="0" {% if not ticket.assigned_to %} disabled selected{% endif %}>
                                                {% trans "Unassigned" %}
                                            </option>
                                            {% for user in assignable_users %}
                                                <option value="{{ user.id }}" {% if ticket.assigned_to and ticket.assigned_to.id == user.id %}selected{% endif %}>
                                                    {{ user.get_full_name|default:user.username }}
                                                </option>
                                            {% endfor %}
                                        </select>

                                        <div class="input-group-append">
                                            <button class="btn btn-primary btn-sm" type="submit" data-toggle="tooltip"
                                                    title="{% trans 'Save ticket assignment' %}">
                                                <i class="fas fa-user-check"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <span class="text-muted px-1">|</span>

                                    <!-- self assign hand -->
                                    <!-- <a class="btn btn-primary btn-sm" data-toggle="tooltip" href="?take"
                                    title="{% trans 'Assign this ticket to ' %}{{ request.user.email }}">
                                        <i class="fas fa-hand-paper"></i>
                                    </a> -->
                                </div>
                            </form>
                        </td>
                        <th class="table-active">{% trans "Submitter E-Mail" %}</th>
                        <td>
                            {{ ticket.submitter_email }}
                            {% if user.is_superuser %}
                                {% if submitter_userprofile_url %}
                                    <!-- <a class="btn btn-primary btn-sm" data-toggle="tooltip" href='{{submitter_userprofile_url}}' title='{% trans "Edit " %}{{ ticket.submitter_email }}{% trans " user profile" %}'>
                                        <i class="fas fa-address-book"></i>
                                    </a> -->
                                {% endif %}
                                    <!-- <a class="btn btn-primary btn-sm" data-toggle="tooltip" href ="{% url 'helpdesk:list'%}?q={{ticket.submitter_email}}" title='{% trans "Display tickets filtered for " %}{{ ticket.submitter_email }}{% trans " as a keyword" %}'>
                                        <i class="fas fa-search"></i>
                                    </a>
                                    <a class="btn btn-warning btn-sm float-right" data-toggle="tooltip" href='{% url 'helpdesk:email_ignore_add' %}?email={{ ticket.submitter_email }}' title='{% trans "Add email address for the ticket system to ignore." %}'>
                                        <i class="fas fa-eye-slash"></i>
                                    </a> -->
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th class="table-active">{% trans "Priority" %}</th>
                        <td class="{% if ticket.priority < 3 %}table-warning{% endif %}">
                            {{ ticket.get_priority_display }}
                        </td>
                        <th class="table-active">{% trans "Department" %}</th>
                        <td>{{ ticket.queue }}</td>
                    </tr>
                    <tr>
                        <th class="table-active">{% trans "Copies To" %}</th>
                        <td colspan="3">
                          {% if ticket.queue.enable_notifications_on_email_events %}
                            {{ ticketcc_string }}
                            <a class="btn btn-warning btn-sm float-right" data-toggle='tooltip' href='{% url 'helpdesk:ticket_cc' ticket.id %}' title='{% trans "Click here to add / remove people who should receive an e-mail whenever this ticket is updated." %}'>
                                <i class="fa fa-share"></i>
                            </a>
                            {% if SHOW_SUBSCRIBE %}
                                <a class="btn btn-warning btn-sm float-right" data-toggle='tooltip' href='?subscribe' title='{% trans "Click here to subscribe yourself to this ticket, if you want to receive an e-mail whenever this ticket is updated." %}'>
                                    <i class="fas fa-rss-square"></i>
                                </a>
                            {% endif %}
                          {% else %}
                            <p class="btn btn-info btn-sm" data-toggle='tooltip' title='{% trans "Assigned queue does not have CC notifications enabled." %}'>{% trans "Disabled" %}</p>
                          {% endif %}
                        </td>
                    </tr>

		    <tr>
			<th class="table-active">{% trans "Status" %}</th>
			<td>{{ ticket.get_status }}</td>
                            {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}
                                <th class="table-active">{% trans "Total time spent" %}</th>
                                <td>{{ ticket.time_spent_formated }}</td>
                            {% else %}
                                <th class="table-active"></th>
                                <td></td>
                            {% endif %}
		    </tr>
                    {% if helpdesk_settings.HELPDESK_ENABLE_DEPENDENCIES_ON_TICKET != False %}
		    <tr>
			<th class="table-active">
			    {% trans "Resolves" %}
			    <a data-toggle='tooltip' href='{% url 'helpdesk:ticket_resolves_add' ticket.id %}'
			       title='{% trans "Make this ticket resolve another ticket." %}'>
				<button type="button" class="btn btn-primary btn-sm float-right"><i class="fas fa-link"></i></button></a>
			</th>
			<td colspan="3" class="p-0">
			    {% for resolves in ticket.depends_on.all %}
			    {% if forloop.first %}<table class="table table-borderless table-responsive m-0">{% endif %}
				<tr>
				    <td>
					<a data-toggle='tooltip' href='{% url 'helpdesk:ticket_resolves_del' resolves.ticket.id resolves.id %}'
					   title='{% trans "Drop the dependency on this ticket. A ticket may not be closed until all tickets it depends on are closed or removed." %}'>
					    <button type="button" class="btn btn-warning btn-sm"><i class="fas fa-trash"></i></button></a>
				    </td>
				    <td>{{ resolves.ticket.get_status_display }}</td>
				    <td>
					<a href='{{ resolves.ticket.get_absolute_url }}'>{{ resolves.ticket.ticket }} {{ resolves.ticket.title }}</a>
				    </td>
				</tr>
				{% if forloop.last %}</table>{% endif %}
			    {% empty %}
			    <small class="p-2">{% trans "This ticket does not resolve any other" %}</small>
			    {% endfor %}
			</td>
		    </tr>
		    <tr>
			<th class="table-active">
			    {% trans "Depends" %}
			    <a data-toggle='tooltip' href='{% url 'helpdesk:ticket_dependency_add' ticket.id %}'
			       title='{% trans "Make this ticket dependent on another ticket. A ticket may not be closed until all tickets it depends on are closed or removed." %}'>
				<button type="button" class="btn btn-primary btn-sm float-right"><i class="fas fa-link"></i></button></a>

			</th>
                        <td colspan="3" class="p-0">
                            {% for dep in dependencies %}
			    {% if forloop.first %}<table class="table table-borderless table-hover table-responsive m-0">{% endif %}
				<tr>
				    <td>
					<a data-toggle='tooltip' href='{% url 'helpdesk:ticket_dependency_del' ticket.id dep.id %}'
					   title='{% trans "Drop the dependency on this ticket. A ticket may not be closed until all tickets it depends on are closed or removed." %}'>
					    <button type="button" class="btn btn-warning btn-sm"><i class="fas fa-trash"></i></button></a>
				    </td>
				    <td>{{ dep.depends_on.get_status_display }}</td>
				    <td>
					<a href='{{ dep.depends_on.get_absolute_url }}'>{{ dep.depends_on.ticket }} {{ dep.depends_on.title }}</a>

				    </td>
                                    {% if forloop.last %}</table>{% endif %}
                            {% empty %}
                            <small class="p-2">{% trans "This ticket has no dependencies." %}</small>
                            {% endfor %}
                        </td>
		    </tr>
		    {% endif %}
                    {% if ticket.kbitem %}
                        <tr>
                            <th class="table-active">{% trans "Knowlegebase item" %}</th>
                            <td> <a href ="{{ticket.kbitem.query_url}}"> {{ticket.kbitem}} </a> </td>
                        </tr>
		    {% endif %}
		    {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
                    <tr>
                        <th class="table-active">{% trans "Attachments" %}</th>
                        <td colspan="3">
                            <ul>
                            {% for followup in ticket.followup_set.all %}
                                {% for attachment in followup.followupattachment_set.all %}
                                    <li>
                                        <a href='{{ attachment.file.url }}'>
                                            {{ attachment.filename }}
                                        </a> ({{ attachment.mime_type }}, {{ attachment.size|filesizeformat }})
                                        {% if followup.user and request.user == followup.user %}
                                            <a class="btn btn-danger btn-sm" href='{% url 'helpdesk:attachment_del' ticket.id attachment.id %}'>
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    {% endif %}

                    <tr>
                        <td id="ticket-description" colspan='4'>
                            <h4>{% trans "Description" %}</h4>
                            {{ ticket.get_markdown|urlizetrunc:50|num_to_link }}
                        </td>
                    </tr>

                    {% if ticket.resolution %}
                        <tr>
                            <th colspan='4'>
                                {% trans "Resolution" %}
                                {% if "Resolved" == ticket.get_status_display %}
                                    <a href='?close'>
                                        <button type="button" class="btn btn-warning btn-sm">
                                        {% trans "Accept and Close" %}
                                        </button>
                                    </a>
                                {% endif %}
                            </th>
                        </tr>
                        <tr>
                            <td colspan='4'>{{ ticket.get_resolution_markdown|urlizetrunc:50|linebreaksbr }}</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            <a href='#FurtherEditOptions'>
                <button type="button" class="btn btn-sm btn-warning float-right" onclick="$('#FurtherEditOptions').fadeIn()">
                    <i class="fas fa-pencil-alt"></i>&nbsp;{% trans "Edit details" %}
                </button>
            </a>
        </div>
        <!-- /.table-responsive -->
    </div>
    <!-- /.card-body -->
</div>
<!-- /.card -->

