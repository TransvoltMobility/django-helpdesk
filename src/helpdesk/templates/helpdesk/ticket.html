{% extends "helpdesk/base.html" %}
{% load i18n bootstrap4form humanize %}
{% load static %}

{% block helpdesk_head %}
<style>
    /* Enhanced styling for admin ticket view */
    body {
        background-color: #f6f8fa;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
    }
    
    /* Main container styling */
    .ticket-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 0;
        width: 100%;
    }
    
    /* Improved card styling */
    .card {
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .card-header {
        background-color: #183b6b;
        color: white;
        font-weight: 600;
        padding: 15px 20px;
        border-bottom: none;
    }
    
    .card-header i {
        margin-right: 8px;
    }
    
    .card-body {
        padding: 20px;
        background-color: white;
    }
    
    /* Enhanced ticket details table */
    .ticket-details-panel {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .table-responsive table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }
    
    .table-responsive th {
        background-color: #f6f8fa;
        color: #183b6b;
        font-weight: 600;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        width: 200px;
        text-align: left;
    }
    
    .table-responsive td {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        line-height: 1.5;
    }
    
    .table-responsive tr:last-child th,
    .table-responsive tr:last-child td {
        border-bottom: none;
    }
    
    /* Follow-ups styling */
    .list-group-item {
        margin-bottom: 15px;
        border-left: 4px solid #183b6b;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        padding: 20px;
    }
    
    .list-group-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }
    
    .list-group-item.bg-light {
        background-color: #f8f9fa;
    }
    
    .list-group-item-heading {
        color: #183b6b;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .list-group-item .mb-1 {
        color: #183b6b;
    }
    
    /* Comment wrapper styling */
    .comment-wrapper {
        margin-top: 15px;
    }
    
    .comment-body {
        line-height: 1.6;
        color: #333;
        padding: 10px 0;
    }
    
    .changes {
        background-color: #f8f9fa;
        padding: 12px 15px;
        margin-top: 15px;
        border-radius: 4px;
        border-left: 3px solid #28a745;
    }
    
    .changes ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .changes .meta {
        font-weight: 500;
        color: #28a745;
    }
    
    /* Attachment styling */
    .followup-attachment {
        background-color: #f8f9fa;
        padding: 8px 12px;
        margin-top: 10px;
        border-radius: 4px;
        border-left: 3px solid #007bff;
    }
    
    .attachment-size {
        color: #6c757d;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    /* Update section styling */
    .update-ticket-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-top: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
    }
    
    /* Form elements */
    #commentBox {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        font-size: 1rem;
        line-height: 1.5;
        transition: border-color 0.2s ease;
    }
    
    #commentBox:focus {
        border-color: #183b6b;
        outline: none;
        box-shadow: 0 0 0 3px rgba(24, 59, 107, 0.1);
    }
    
    textarea, 
    select, 
    input[type="text"],
    input[type="email"],
    input[type="date"] {
        width: 100%;
        max-width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }
    
    textarea:focus,
    select:focus,
    input:focus {
        border-color: #183b6b;
        outline: none;
        box-shadow: 0 0 0 3px rgba(24, 59, 107, 0.1);
    }
    
    dl {
        margin-bottom: 20px;
    }
    
    dt {
        font-weight: 600;
        color: #183b6b;
        margin-bottom: 8px;
        font-size: 1rem;
    }
    
    dd {
        margin-bottom: 20px;
    }
    
    /* Button styling */
    .btn-warning, .btn-primary {
        background-color: #183b6b;
        border-color: #183b6b;
        color: white;
        font-weight: 500;
        padding: 10px 20px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-warning:hover, .btn-primary:hover {
        background-color: #0e2c57;
        border-color: #0e2c57;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.9rem;
    }
    
    /* Tab styling */
    .nav-tabs {
        border-bottom: 2px solid #183b6b;
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-item {
        margin-bottom: -2px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 6px 6px 0 0;
        padding: 12px 20px;
        font-weight: 500;
        color: #6c757d;
        background-color: #f8f9fa;
        margin-right: 2px;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: #183b6b;
        background-color: #e9ecef;
        border-color: transparent;
    }
    
    .nav-tabs .nav-link.active {
        color: white;
        background-color: #183b6b;
        border-color: #183b6b;
        border-bottom: 2px solid #183b6b;
    }
    
    .tab-content {
        background-color: white;
        padding: 0;
        border-radius: 0 0 8px 8px;
    }
    
    /* Status radio buttons styling */
    .radio-inline {
        display: inline-block;
        margin-right: 15px;
        margin-bottom: 10px;
        padding: 8px 15px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: white;
    }
    
    .radio-inline:hover {
        border-color: #183b6b;
        background-color: #f8f9fa;
    }
    
    .radio-inline.active {
        border-color: #183b6b;
        background-color: #183b6b;
        color: white;
    }
    
    .radio-inline input[type="radio"] {
        margin-right: 8px;
    }
    
    /* File upload styling */
    #FileUpload {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
        margin-top: 15px;
        border: 2px dashed #dee2e6;
    }
    
    .btn-file {
        position: relative;
        overflow: hidden;
    }
    
    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        cursor: inherit;
        display: block;
    }
    
    /* Responsive design */
    @media (max-width: 1200px) {
        .ticket-container {
            width: 95%;
            max-width: 1400px;
        }
    }
    
    @media (max-width: 768px) {
        .ticket-container {
            width: 100%;
            padding: 0 10px;
        }
        
        .card-header {
            padding: 12px 15px;
        }
        
        .card-body {
            padding: 15px;
        }
        
        .table-responsive th {
            width: 120px;
            padding: 10px 15px;
        }
        
        .table-responsive td {
            padding: 10px 15px;
        }
        
        .nav-tabs .nav-link {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
    }
    
    /* Enhanced ticket title links */
    table a.ticket-title,
    table td a {
        color: #183b6b;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }
    
    table td a:hover {
        color: #0e2c57;
        text-decoration: underline;
    }
    
    /* Alert styling */
    .alert {
        border-radius: 6px;
        padding: 15px 20px;
        margin-bottom: 20px;
    }
    
    /* Form help text */
    .form_help_text {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
        line-height: 1.4;
    }
    
    /* Merge ticket notification */
    .card.card-body.bg-light {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
        padding: 20px;
    }
    
    .card.card-body.bg-light h3 {
        color: #856404;
        margin-bottom: 0;
    }
    
    /* Edit buttons styling */
    .followup-edit .btn {
        transition: all 0.2s ease;
    }
    
    .followup-edit .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}


{% block helpdesk_title %}{{ ticket.queue.slug }}-{{ ticket.id }} : {% trans "View Ticket Details" %}{% endblock %}

{% block h1_title %}{{ ticket.ticket_for_url }}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
</li>
<li class="breadcrumb-item active">
    {{ ticket.queue.slug }}-{{ ticket.id }}
</li>
{% endblock %}

{% block helpdesk_body %}
<div class="ticket-container">
    {% if form.errors %}
        {% include 'helpdesk/include/alert_form_errors.html' %}
    {% endif %}
    {% if helpdesk_settings.HELPDESK_TRANSLATE_TICKET_COMMENTS %}
        <div id="google_translate_element"></div>
        <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs" id="ticketTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="details-tab" data-toggle="tab" href="#details" 
                       role="tab" aria-controls="details" aria-selected="true">
                        <i class="fas fa-info-circle"></i> {% trans "Details" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="followups-tab" data-toggle="tab" href="#followups" 
                       role="tab" aria-controls="followups" aria-selected="false">
                        <i class="fas fa-comments"></i> {% trans "History" %}
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="ticketTabsContent">
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    {% if ticket.merged_to %}
                        <div class="card card-body bg-light">
                            <h3 class="text-center">
                                {% trans "This ticket has been merged into ticket" %}
                                <a href="{{ ticket.merged_to.get_absolute_url }}">{{ ticket.merged_to }}</a>
                            </h3>
                        </div>
                    {% else %}
                        {% include "helpdesk/ticket_desc_table.html" %}
                        
                        <div class="card mb-3 update-ticket-section">
                            <div class="card-header"><i class="fas fa-reply fa-fw"></i>{% trans "Update Ticket" %}</div>
                            <div class="card-body">

                         <form method="post" action="{% url 'helpdesk:update' ticket.id %}" enctype="multipart/form-data" style="width: 100%">

                        <fieldset style="width: 100%;">
                            <dl style="width: 100%;">
                                {% if preset_replies %}
                                <dt><label for='id_preset'>{% trans "Use a Pre-set Reply" %}</label> <span class='form_optional'>{% trans "(Optional)" %}</span></dt>
                                <dd>
                                    <select name='preset' id='id_preset'>
                                        <option value=''>{% trans "Choose..." %}</option>
                                        {% for preset in preset_replies %}
                                        <option value='{{ preset.id }}'>{{ preset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </dd>
                                <dd class='form_help_text'>{% trans "Selecting a pre-set reply will over-write your comment below. You can then modify the pre-set reply to your liking before saving this update." %}</dd>
                                {% endif %}

                                <dt><label for='commentBox'>{% trans "Comment / Resolution" %}</label> <span class='form_optional'>{% trans "(Optional)" %}</span></dt>
                                <dd><textarea rows='8' name='comment' id='commentBox'></textarea></dd>
                                {% url "helpdesk:help_context" as context_help_url %}

                                {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
                                <dt><label>{% trans "Attach File(s)" %}</label> <span class='form_optional'>{% trans "(Optional)" %}</span></dt>
                                <dd>
                                    <div class="add_file_fields_wrap">
                                        <div style="display: flex; gap: 10px; align-items: baseline; margin-bottom: 10px;">
                                            <label class='btn btn-primary btn-sm btn-file' style="margin-bottom: 0; vertical-align: baseline;">
                                                Browse... <input type="file" name='attachment' id='file0' style='display: none;'/>
                                            </label>
                                            <button class="add_file_field_button btn btn-success btn-sm" style="margin-bottom: 0; vertical-align: baseline;">{% trans "Add Another File" %}</button>
                                            <span id='selectedfilename0' style="line-height: 31px; vertical-align: baseline;">{% trans 'No files selected.' %}</span>
                                        </div>
                                    </div>
                                    <p id='ShowFileUploadPara' style='display: none;'>
                                        <button class="btn btn-warning btn-sm" id='ShowFileUpload'>
                                            <i class="fas fa-paperclip"></i> {% trans "Attach File(s)" %} &raquo;
                                        </button>
                                    </p>
                                    <div id='FileUpload' style='display: none;'>
                                    </div>
                                </dd>
                                {% endif %}

                                <dt><label>{% trans "New Status" %}</label></dt>
                                {% if not ticket.can_be_resolved %}<dd>{% trans "This ticket cannot be resolved or closed until the tickets it depends on are resolved." %}</dd>{% endif %}
                                <dd><div class="form-group">
                                {% for status_choice in ticket.get_allowed_status_flow %}
                                    <label for='st_{{ status_choice.1|lower }}' class='{% if ticket.status == status_choice.0 %}active {% endif %}radio-inline'><input type='radio' name='new_status' value='{{ status_choice.0 }}' id='st_{{ status_choice.1|lower }}'{% if not ticket.can_be_resolved %} disabled='disabled'{% endif %}{% if ticket.status == status_choice.0 %} checked='checked'{% endif %}>{{ status_choice.1 }}{% if forloop.last %}{% else %} &raquo;{% endif %}</label>
                                {% endfor %}
                                </div></dd>

                                {% if helpdesk_settings.HELPDESK_UPDATE_PUBLIC_DEFAULT %}
                                <input type='hidden' name='public' value='1'>
                                {% else %}
                                <dt>
                                    <label for='id_public'>{% trans "Is this update public?" %}</label> <span class='form_optional'>{% trans "(Optional)" %}</span>
                                </dt>
                                <dd><input type='checkbox' name='public' value='1' checked='checked' />&nbsp; {% trans 'Yes, make this update public.' %}</dd>
                                <dd class='form_help_text'>{% trans "If this is public, the submitter will be e-mailed your comment or resolution." %}</dd>
                                {% endif %}
                            </dl>

                        <p id='ShowFurtherOptPara'><button type="button" class="btn btn-warning btn-sm" id='ShowFurtherEditOptions'>{% trans "Change Further Details &raquo;" %}</button></p>

                        <div id='FurtherEditOptions' style='display: none;'>

                            <dl>

                                <dt><label for='id_title'>{% trans "Title" %}</label></dt>
                                <dd><input type='text' name='title' value='{{ ticket.title|escape }}' /></dd>

                                <dt><label for='id_owner'>{% trans "Owner" %}</label></dt>
                                <dd>
                                    <select id='id_owner' name='owner'>
                                        <option value='0'>{% trans "Unassigned" %}</option>
                                        {% for u in assignable_users %}
                                            <option value='{{ u.id }}'{% if u.id == ticket.assigned_to.id %} selected{% endif %}>{{ u }}</option>
                                        {% endfor %}
                                    </select>
                                </dd>

                                <dt><label for='id_priority'>{% trans "Priority" %}</label></dt>
                                <dd><select id='id_priority' name='priority'>{% for p in priorities %}{% if p.0 == ticket.priority %}<option value='{{ p.0 }}' selected='selected'>{{ p.1 }}</option>{% else %}<option value='{{ p.0 }}'>{{ p.1 }}</option>{% endif %}{% endfor %}</select></dd>

                                <dt><label for='id_queue'>{% trans "Queue" %}</label></dt>
                                <dd><select id='id_queue' name='queue'>{% for queue_id, queue_name in queues %}<option value='{{ queue_id }}'{% if queue_id == ticket.queue.id %} selected{% endif %}>{{ queue_name }}</option>{% endfor %}</select></dd>

                                <dt><label for='id_due_date'>{% trans "Due on" %}</label></dt>
                                <dd>{{ form.due_date }}</dd>

                            </dl>

                            <dl>
                                <dt>{{ customfields_form }}</dt>
                            </dl>

                        </div>

                        {% if ticket.checklists.exists %}
                            <p>
                                <button type="button" class="btn btn-warning btn-sm" id='ShowChecklistEditOptions'>
                                    {% trans "Update checklists" %} &raquo;
                                </button>
                            </p>

                            <div id="checklistEdit" style="display: none">
                                <div class="row">
                                    {% for checklist in ticket.checklists.all %}
                                        <div class="col-sm-4 col-xs-12">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5>{{ checklist }}</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="list-group">
                                                        {% for task in checklist.tasks.all %}
                                                            <div class="list-group-item"{% if task.completion_date %} title="{% trans "Completed on" %} {{ task.completion_date }}" {% endif %}>
                                                                <label>
                                                                    <input
                                                                            name="checklist-{{ checklist.id }}"
                                                                            type="checkbox"
                                                                            value="{{ task.id }}"
                                                                            {% if task.completion_date %}checked{% endif %}
                                                                    />
                                                                    {{ task.description }}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        </fieldset>

                        <button class="btn btn-primary float-right" type='submit' onclick='$("#ShowFurtherEditOptions").click()'>{% trans "Update This Ticket" %}</button>

                        {% csrf_token %}</form>

                            </div>
                        </div>
                    {% endif %}
                </div>
                <!-- End of details tab -->
                
                <div class="tab-pane fade" id="followups" role="tabpanel" aria-labelledby="followups-tab">
                    {% if ticket.followup_set.all %}
                    {% load ticket_to_link %}
                        <div class="card mb-3">
                            <div class="card-header"><i class="fas fa-clock fa-fw fa-lg"></i>{% trans "History" %}</div>
                            <div class="card-body">
                                <div class="list-group">
                                {% for followup in ticket.followup_set.all %}
                                    <div class="list-group-item{% if not followup.public %} bg-light{% endif %}">
                                        <h6 class="list-group-item-heading d-flex justify-content-between align-items-center">
                                            {% if followup.staff_name %}
                                                <span>{{ followup.staff_name }}</span>
                                            {% else %}
                                                <span>{% if followup.user %}{{ followup.user }}{% else %}{{ followup.user_display_text }}{% endif %}</span>
                                            {% endif %}
                                            <small class="text-muted"><i class="fas fa-clock"></i> {{ followup.date|date:"DATETIME_FORMAT" }} ({{ followup.date|naturaltime }})</small>
                                        </h6>

                                        <div class="comment-wrapper mb-1">
                                            <div class="comment-body">{{ followup.comment|force_escape|num_to_link|linebreaksbr }}</div>

                                            {% if followup.ticketchange_set.all %}
                                                <div class='changes'>
                                                    <ul class='list-unstyled'>
                                                        {% for change in followup.ticketchange_set.all %}
                                                        <li>
                                                        <span class='meta'>
                                                            {% blocktrans with change.field as field and change.old_value as old_value and change.new_value as new_value %}Changed {{ field }} from {{ old_value }} to {{ new_value }}.{% endblocktrans %}
                                                        </span>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            {% endif %}
                                        </div>

                                        {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
                                            {% for attachment in followup.attachment_set.all %}
                                                <div class="followup-attachment">
                                                    <a href='{{ attachment.file.url }}'>
                                                        <i class="fas fa-paperclip"></i> {{ attachment.filename }}
                                                    </a>
                                                    <span class='attachment-size'>{{ attachment.mime_type }}, {{ attachment.size|filesizeformat }}</span>
                                                </div>
                                            {% endfor %}
                                        {% endif %}

                                        <!-- Controls for editing followups -->
                                        {% with possible=helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                                            {% if  possible and followup.user and request.user == followup.user and not followup.ticketchange_set.all or  possible and user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                                            <small class="d-flex justify-content-end align-items-center gap-2">
                                                {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                                                    {% if followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                                                    <a href="{% url 'helpdesk:followup_edit' ticket.id followup.id %}" class='followup-edit'><button type="button" class="btn btn-warning btn-sm float-right"><i class="fas fa-edit"></i></button></a>
                                                    {% endif %}
                                                {% endif %}
                                                {% if user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                                                    {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP and followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                                                        <span class="text-muted px-2">|</span>
                                                    {% endif %}
                                                    <a href="{% url 'helpdesk:followup_delete' ticket.id followup.id %}" class='followup-edit'><button type="button" class="btn btn-warning btn-sm float-right"><i class="fas fa-trash"></i></button></a>
                                                {% endif %}
                                            </small>
                                        {% endif %}{% endwith %}
                                    </div>
                                    <!-- /.list-group-item -->
                                {% endfor %}
                                </div>
                                <!-- /.list-group -->
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    {% else %}
                        <div class="alert alert-info">
                            {% trans "This ticket has no history yet." %}
                        </div>
                    {% endif %}
                </div>
                <!-- End of followups tab -->
            </div>
            <!-- /.tab-content -->
        </div>
        <!-- /.card-body -->
    </div>
    <!-- /.card -->
</div>

{% endblock %}


{% block helpdesk_js %}
<script type='text/javascript' language='javascript'>
$( function() {
        $( "#id_due_date" ).datepicker({dateFormat: 'yy-mm-dd'});
} );
</script>

<script type='text/javascript' language='javascript'>
  $(document).ready(function() {
      $("#ShowFurtherEditOptions").click(function() {
          $("#FurtherEditOptions").toggle();
      });

      $("#ShowChecklistEditOptions").click(function() {
          $("#checklistEdit").toggle();
      });

      $('#id_preset').change(function() {
          preset = $('#id_preset').val();
          if (preset != '') {
              $.get("{% url 'helpdesk:raw' 'preset' %}?id=" + preset, function(data) {
                  $("#commentBox").val(data)
              });
          }
      });

      // Preset name of checklist when a template is selected
      $('#id_checklist_template').on('change', function() {
          const nameField = $('#id_name')
          const selectedTemplate = $(this).children(':selected')
          if (nameField.val() === '' && selectedTemplate.val()) {
              nameField.val(selectedTemplate.text())
          }
      })

      $('.disabledTask').on('click', () => {
          alert("{% trans 'If you want to update state of checklist tasks, please do a Follow-Up response and click on Update checklists' %}")
      })

      $("[data-toggle=tooltip]").tooltip();

      {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
      $("#ShowFileUpload").click(function(e) {
          e.preventDefault();
          e.stopPropagation();
          $("#FileUpload").fadeIn();
          $("#ShowFileUploadPara").hide();
          return false;
      });

      // lists for file input change events, then updates the associated text label
      // with the file name selected
      $('.add_file_fields_wrap').on('fileselect', ':file', function(event, numFiles, label, browseButtonNum) {
          $("#selectedfilename"+browseButtonNum).html(label);
      });

      var x = 0;
      var wrapper = $(".add_file_fields_wrap");
      var add_button = $(".add_file_field_button");

      $(add_button).click(function(e){
          e.preventDefault();
          x++;
          $(wrapper).append('<div style="display: flex; gap: 10px; align-items: baseline; margin-bottom: 10px;"><label class="btn btn-primary btn-sm btn-file" style="margin-bottom: 0; vertical-align: baseline;">Browse... <input type="file" name="attachment" id="file' + x + '" style="display: none;"/></label><span id="selectedfilename' + x + '" style="line-height: 31px; vertical-align: baseline;">No files selected.</span></div>');
      });
      {% endif %}
  });

  // Update filename display on file selection
  $(document).on('change', ':file', function() {
      var input = $(this),
          inputWidgetNum = $(this).attr('id').split("file")[1],
          numFiles = input.get(0).files ? input.get(0).files.length : 1,
          label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
      input.trigger('fileselect', [numFiles, label, inputWidgetNum]);
  });
</script>
{% endblock %}
